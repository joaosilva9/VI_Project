<!DOCTYPE html>

<head>
    <meta charset="utf-8"> 
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

</head>


<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Football</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <a class="nav-link" href="../src/home.html">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../src/players.html">Players</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link " href="#">Teams</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="#">Leagues</a>
            </li>
            </ul>
            <form class="form-inline my-2 my-lg-0">
            <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
            </form>
        </div>
    </nav>
    <br/>


    <div class = "scorers">
        <div class = "header">
            <div class = "row  ">
                <h3 class = "col-md-6" style = "text-align: right;"> Best Scorers </h3>
                <select class="form-control ligue col-md-2 float-left" style = "width : 100px;" >
                    <option selected="selected">Bundesliga</option>
                    <option>SPANISH</option>
                </select>
                <div class = "col-md-4"></div>
            </div>
        </div>
        <br/>
        <br/>
        <div class = "graphic"></div>
    </div>
    

    <script>
        function containsObject(obj, list) {
            var i;
            for (i = 0; i < list.length; i++) {
                if (list[i].id == obj) {
                    return true;
                }
            }

            return false;
        }

        function parseGoals(goals){                             //scorers = {id : goal};
            let parser = new DOMParser();
            let xmlDoc = parser.parseFromString(goals,"text/xml");
            var rows = xmlDoc.getElementsByTagName("player1");
            for (let i = 0; i < rows.length; i++){
                let row = rows[i];
                let scorer = row.childNodes[0].nodeValue;
                if (!(containsObject(scorer, scorers))){
                    scorers.push({id : scorer, goals : 1});
                } else{
                    var foundIndex = scorers.findIndex(x => x.id == scorer);
                    scorers[foundIndex].goals++;
                }
            }
        }

        function compare(a, b) {
            if (a < b) {
                return -1;
            } else if (a > b) {
                return 1;
            } else {
                return 0;
            }
        }

        function load_matches(ligue){
            let top_scorers;
            d3.csv("../files/Matches.csv", function(games) {
                scorers = [];
            
                for (let i = 0; i < games.length; i++){
                    
                    if (games[i].league_id == leagues[ligue]){
                        let goals = (games[i].goal != null && games[i].goal != 'None' && games[i].goal.includes("value")) ? games[i].goal : 0; 
                        if (goals != 0){
                            parseGoals(goals);
                        }
                    }
                    
                }

                let array = scorers.map(a => a.goals);
                array = Array.from(new Set(array));
                array = array.sort(compare);
                
                array = array.reverse();
                let array2 = array.slice(0, 5);
                
                top_scorers = scorers.filter(scorer => array2.includes(scorer.goals));
                d3.csv("../files/Players.csv", function(players) {
                    let ids = top_scorers.map(scorer => scorer.id);
                    for (let i = 0; i < players.length; i++){
                        if (ids.includes(players[i].player_api_id.trim())){
                            console.log(players[i].player_name);
                            var foundIndex = top_scorers.findIndex(x => x.id == players[i].player_api_id.trim());
                            top_scorers[foundIndex].name = players[i].player_name;
                        }
                    }

                    print_results(top_scorers);
                })
            })
        }

        
        function plot_chart(data){
                //sort bars based on value
            data = data.sort(function (a, b) {
                return d3.ascending(a.goals, b.goals);
            })

            //set up svg using margin conventions - we'll need plenty of room on the left for labels
            var margin = {
                top: 15,
                right: 25,
                bottom: 15,
                left: 400
            };

            var width = 960 - margin.left - margin.right,
                height = 300 - margin.top - margin.bottom;

            var svg = d3.select(".graphic").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            
            
            var x = d3.scale.linear()
                .range([0, width])
                .domain([0, d3.max(data, function (d) {
                    return d.goals;
                })]);

            var y = d3.scale.ordinal()
                .rangeRoundBands([height, 0], .1)
                .domain(data.map(function (d) {
                    return d.name;
                }));

            //make y axis to show bar names
            var yAxis = d3.svg.axis()
                .scale(y)
                //no tick marks
                .tickSize(0)
                .orient("left");

            var gy = svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)

            var bars = svg.selectAll(".bar")
                .data(data)
                .enter()
                .append("g")

            //append rects
            bars.append("rect")
                .attr("class", "bar")
                .attr("y", function (d) {
                    return y(d.name);
                })
                .attr("height", y.rangeBand())
                .attr("x", 0)
                .attr("width", function (d) {
                    return x(d.goals);
                });

            //add a value label to the right of each bar
            bars.append("text")
                .attr("class", "label")
                //y position of the label is halfway down the bar
                .attr("y", function (d) {
                    return y(d.name) + y.rangeBand() / 2 + 4;
                })
                //x position is 3 pixels to the right of the bar
                .attr("x", function (d) {
                    return x(d.goals);
                })
                .text(function (d) {
                    return d.goals;
                });
        }

        function print_results(top_scorers){
            d3.select(".scorers")
                .append("div")
                .attr("class", "body")
                
            plot_chart(top_scorers);
        }

        function change(){
            let ligue = d3.select(".ligue").node().value;
            d3.select(".graphic").html("");
            load_matches(ligue);

            
        }

        

        let scorers = [];
        let leagues = {
            "Bundesliga" : 7809,
            "SPANISH" : 21518,

        };
        d3.select(".ligue").on("change", change);
        
        
        

        
        
        
        
        
    </script>



</body>

</html>